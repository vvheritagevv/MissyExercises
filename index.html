<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Exercise Program</title>

  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b1220; color:#e5e7eb; }
    header { padding:16px; position:sticky; top:0; background:#0b1220cc; backdrop-filter: blur(8px); border-bottom:1px solid #243045; z-index:10; }
    h1 { margin:0; font-size:18px; }

    .muted { color:#9ca3af; font-size:12px; }
    .small { font-size:12px; }
    main { padding:16px; max-width:1100px; margin:0 auto; }

    .tabs { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    button, input, select { font:inherit; }

    .tab, .btn {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #243045;
      background:#111b2f;
      color:#e5e7eb;
      cursor:pointer;
    }
    .tab.active { background:#1f2a44; border-color:#3b4b6a; }
    .btn.danger { background:#b91c1c; border-color:#b91c1c; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spaced { justify-content:space-between; }

    .card { background:#0f1a2e; border:1px solid #243045; border-radius:14px; padding:12px; }

    details.round { background:#0f1a2e; border:1px solid #243045; border-radius:14px; overflow:hidden; }
    summary { list-style:none; cursor:pointer; padding:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    summary::-webkit-details-marker { display:none; }

    .badge {
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #243045;
      background:#111b2f;
      font-size:12px;
      color:#cbd5e1;
    }

    .repGrid { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-top:10px; }
    .repCell { display:flex; gap:8px; align-items:center; padding:10px; border:1px solid #243045; border-radius:12px; background:#0b1220; flex-wrap:wrap; }
    .repNum { font-size:12px; color:#cbd5e1; }

    .holdWrap { width:100%; display:flex; justify-content:flex-end; gap:8px; }
    .holdBtn { padding:8px 10px; font-size:12px; }

    @media (max-width:420px){ .repGrid{ grid-template-columns:repeat(3,1fr);} }
    @media (min-width:421px) and (max-width:720px){ .repGrid{ grid-template-columns:repeat(4,1fr);} }

    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border-bottom:1px solid #243045; padding:8px; font-size:13px; }
  </style>
</head>

<body>
<header>
  <h1>Home Exercise Program</h1>
  <div class="muted" id="todayLine"></div>

  <div class="tabs">
    <button class="tab active" data-tab="today">Today</button>
    <button class="tab" data-tab="history">History</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>
</header>

<main>
<section id="today">
  <div class="row spaced">
    <div>
      <div class="muted">4 rounds per day • progress auto-saves</div>
      <div class="muted small" id="progressLine"></div>
    </div>
    <div class="row">
      <button class="btn" id="installBtn" hidden>Install App</button>
      <button class="btn" id="exportPdfBtn">Export PDF</button>
      <button class="btn" id="expandAllBtn">Expand</button>
      <button class="btn" id="collapseAllBtn">Collapse</button>
      <button class="btn danger" id="resetTodayBtn">Reset</button>
    </div>
  </div>

  <div id="roundsWrap" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;"></div>
</section>

<section id="history" hidden>
  <div class="row spaced">
    <div class="muted">History</div>
    <button class="btn danger" id="deleteAllBtn">Delete All</button>
  </div>
  <div id="historyWrap"></div>
</section>

<section id="settings" hidden>
  <div class="card">
    <div class="muted">Program overview</div>
    <div id="programGrid" style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px;"></div>
  </div>
</section>
</main>

<script>
/* ================= INSTALL ================= */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  installBtn.hidden=false;
});
installBtn.onclick=async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt=null;
  installBtn.hidden=true;
};

/* ================= AUDIO ================= */
let audioCtx;
function beep(freq=800,ms=120){
  audioCtx ||= new (window.AudioContext||webkitAudioContext)();
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.frequency.value=freq; g.gain.value=.05;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); setTimeout(()=>o.stop(),ms);
}

/* ================= DATA ================= */
const LS="hep_android_pwa";
const PROGRAM=[
 ["heel","Supine Heel Slide",10,5],
 ["glute","Gluteal Set",10,10],
 ["quad","Quad Set",10,10],
 ["slr","Straight Leg Raise",10,0],
 ["bridge","Glute Bridge",10,10],
 ["laq","Eccentric Long Arc Quad",10,0],
 ["ankle","Ankle Pumps",10,0]
];

let store=JSON.parse(localStorage.getItem(LS)||"{}");
const today=new Date().toISOString().slice(0,10);
store[today]??={ rounds:Array.from({length:4},()=>Object.fromEntries(PROGRAM.map(e=>[e[0],Array(e[2]).fill(false)]))), pain:Array(4).fill(null) };

function save(){ localStorage.setItem(LS,JSON.stringify(store)); }

/* ================= RENDER ================= */
const $=s=>document.querySelector(s);
todayLine.textContent=`Today: ${today}`;

function render(){
  roundsWrap.innerHTML="";
  let done=0,total=0;
  store[today].rounds.forEach((round,r)=>{
    const d=document.createElement("details");
    d.className="round"; d.open=r===0;
    d.innerHTML=`<summary><b>Round ${r+1}</b><span class="badge">${store[today].pain[r]!=null?`Pain ${store[today].pain[r]}/10`:""}</span></summary><div></div>`;
    const body=d.querySelector("div");

    const pain=document.createElement("div");
    pain.className="card";
    pain.innerHTML=`Pain (0–10): <select>${["","0","1","2","3","4","5","6","7","8","9","10"].map(v=>`<option ${v==store[today].pain[r]?"selected":""}>${v}</option>`).join("")}</select>`;
    pain.querySelector("select").onchange=e=>{store[today].pain[r]=e.target.value===""?null:+e.target.value;save();render();};
    body.appendChild(pain);

    PROGRAM.forEach(ex=>{
      const c=document.createElement("div"); c.className="card";
      c.innerHTML=`<b>${ex[1]}</b><div class="repGrid"></div>`;
      const g=c.querySelector(".repGrid");
      round[ex[0]].forEach((v,i)=>{
        const cell=document.createElement("div"); cell.className="repCell";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=v;
        cb.onchange=()=>{round[ex[0]][i]=cb.checked;save();render();};
        cell.append(cb,`#${i+1}`);
        if(ex[3]){
          const b=document.createElement("button");
          b.className="btn holdBtn"; b.textContent="Start";
          b.onclick=()=>{let t=ex[3]; beep(500,80);
            const iv=setInterval(()=>{b.textContent=`${--t}s`; if(t<=0){clearInterval(iv);beep(900,120);cb.checked=true;cb.onchange();}},1000);
          };
          const hw=document.createElement("div"); hw.className="holdWrap"; hw.append(b); cell.append(hw);
        }
        g.append(cell);
        total++; if(v) done++;
      });
      body.appendChild(c);
    });
    roundsWrap.append(d);
  });
  progressLine.textContent=`Completed ${done}/${total}`;
}
render();

/* ================= PDF ================= */
exportPdfBtn.onclick=()=>{
  const w=open("","_blank");
  w.document.write(`<pre>${JSON.stringify(store[today],null,2)}</pre>`);
  w.print();
};

/* ================= CONTROLS ================= */
expandAllBtn.onclick=()=>document.querySelectorAll("details").forEach(d=>d.open=true);
collapseAllBtn.onclick=()=>document.querySelectorAll("details").forEach(d=>d.open=false);
resetTodayBtn.onclick=()=>{if(confirm("Reset today?")){delete store[today]; save(); location.reload();}};
deleteAllBtn.onclick=()=>{if(confirm("Delete all data?")){localStorage.clear(); location.reload();}};

document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  document.querySelectorAll("main section").forEach(s=>s.hidden=true);
  $("#"+t.dataset.tab).hidden=false;
});

/* ================= SERVICE WORKER ================= */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
