<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Exercise Program</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1220; color:#e5e7eb; }
    header { padding:16px; position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter: blur(10px); border-bottom:1px solid #243045; z-index:10; }
    h1 { margin:0; font-size:18px; }
    .muted { color:#9ca3af; font-size:12px; }
    main { padding:16px; max-width: 1100px; margin: 0 auto; }

    .tabs { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    button, input { font: inherit; }
    .tab { padding:10px 12px; border-radius:10px; border:1px solid #243045; background:#111b2f; color:#e5e7eb; cursor:pointer; }
    .tab.active { background:#1f2a44; border-color:#3b4b6a; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spaced { justify-content:space-between; }

    .card { background:#0f1a2e; border:1px solid #243045; border-radius:14px; padding:12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; margin-top:12px; }


    .btn { padding:10px 12px; border-radius:10px; border:1px solid #243045; background:#111b2f; color:#e5e7eb; cursor:pointer; }
    .btn.primary { background:#2563eb; border-color:#2563eb; }
    .btn.danger { background:#b91c1c; border-color:#b91c1c; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    details.round { background:#0f1a2e; border:1px solid #243045; border-radius:14px; overflow:hidden; }
    summary { list-style:none; cursor:pointer; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    summary::-webkit-details-marker { display:none; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #243045; background:#111b2f; font-size:12px; color:#cbd5e1; }

    .exTitle { font-weight:600; }
    .exMeta { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .repGrid { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap:8px; margin-top:10px; }

    .repNum { font-size:12px; color:#cbd5e1; min-width:20px; }
.repGrid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 8px;
  margin-top: 10px;
}

/* Make rep cells wrap instead of clipping content */
.repCell {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  border: 1px solid #243045;
  border-radius: 12px;
  background: #0b1220;
  flex-wrap: wrap;              /* ✅ allow wrap */
}

/* Don’t shove hold controls off-screen */
.holdWrap {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: 0;               /* ✅ remove auto push */
  width: 100%;                  /* ✅ forces to new line nicely */
  justify-content: flex-end;    /* ✅ align to right within the cell */
}

.holdTime {
  font-variant-numeric: tabular-nums;
  font-size: 12px;
  color: #cbd5e1;
  min-width: 0;                 /* ✅ don’t force width that can clip */
  text-align: right;
}

/* ✅ Responsive grid: fewer columns on small screens */
@media (max-width: 420px) {
  .repGrid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
}

@media (min-width: 421px) and (max-width: 720px) {
  .repGrid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
}

    .holdBtn { padding:8px 10px; border-radius:10px; border:1px solid #243045; background:#111b2f; color:#e5e7eb; cursor:pointer; font-size:12px; }
    .holdBtn:disabled { opacity:.6; cursor:not-allowed; }

    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #243045; font-size:14px; vertical-align:top; }
    .small { font-size:12px; }
  </style>
</head>
<body>
<header>
  <h1>Home Exercise Program</h1>
  <div class="muted" id="todayLine"></div>
  <div class="tabs">
    <button class="tab active" data-tab="today">Today</button>
    <button class="tab" data-tab="history">History</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>
</header>

<main>
  <section id="today" class="tabpane">
    <div class="row spaced">
      <div>
        <div class="muted">Complete 4 rounds today. Progress auto-saves.</div>
        <div class="muted small" id="progressLine"></div>
      </div>
      <div class="row">
        <button class="btn" id="expandAllBtn">Expand all</button>
        <button class="btn" id="collapseAllBtn">Collapse all</button>
        <button class="btn danger" id="resetTodayBtn">Reset today</button>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:12px;" id="roundsWrap"></div>

    <div class="muted small" style="margin-top:12px;">
      Hold exercises: tap <b>Start</b> to run the countdown. When it hits 0, that rep is auto-checked.
    </div>
  </section>

  <section id="history" class="tabpane" hidden>
    <div class="row spaced">
      <div class="muted">Daily completion summary</div>
      <button class="btn danger" id="deleteAllBtn">Delete all data</button>
    </div>
    <div id="historyWrap" style="margin-top:12px;"></div>
  </section>

  <section id="settings" class="tabpane" hidden>
    <div class="card">
      <div class="muted">Program (fixed to your plan)</div>
      <div class="grid" id="programGrid" style="margin-top:12px;"></div>
      <div class="muted small" style="margin-top:12px;">
        (If you want, I can add: sets, pain score, RPE, notes per round, or a “morning/afternoon/evening/night” schedule.)
      </div>
    </div>
  </section>
</main>

<script>
  // -------------------- Model --------------------
  const LS_KEY = "hep_checklist_pwa_v1";

  const PROGRAM = {
    circuitsPerDay: 4,
    exercises: [
      { id: "heel_slide",  name: "Supine Heel Slide", reps: 10, holdSec: 5,  holdLabel: "hold at top" },
      { id: "glute_set",   name: "Gluteal Set",       reps: 10, holdSec: 10, holdLabel: "hold contraction" },
      { id: "quad_set",    name: "Quad Set",          reps: 10, holdSec: 10, holdLabel: "hold contraction" },
      { id: "slr_flex",    name: "Straight Leg Raise (Flexion)", reps: 10, holdSec: 0, holdLabel: "" },
      { id: "glute_bridge",name: "Glute Bridge",      reps: 10, holdSec: 10, holdLabel: "hold contraction" },
      { id: "laq_ecc",     name: "Eccentric Long Arc Quad (Leg Extension)", reps: 10, holdSec: 0, holdLabel: "" },
      { id: "ankle_pumps", name: "Ankle Pumps",       reps: 10, holdSec: 0, holdLabel: "" }
    ]
  };

  // Data structure:
  // {
  //   days: {
  //     "YYYY-MM-DD": {
  //       createdAt, rounds: [
  //         { exId: { reps: [bool x 10] } ... },
  //         ... 4 rounds
  //       ]
  //     }
  //   }
  // }
  function loadStore() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return { days: {} };
    try {
      const parsed = JSON.parse(raw);
      parsed.days ??= {};
      return parsed;
    } catch {
      return { days: {} };
    }
  }
  function saveStore() { localStorage.setItem(LS_KEY, JSON.stringify(store)); }

  const store = loadStore();

  function yyyyMmDd(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  const todayKey = yyyyMmDd();
  ensureDay(todayKey);

  function ensureDay(dayKey) {
    if (store.days[dayKey]) return;
    const rounds = [];
    for (let r = 0; r < PROGRAM.circuitsPerDay; r++) {
      const roundObj = {};
      for (const ex of PROGRAM.exercises) {
        roundObj[ex.id] = { reps: Array(ex.reps).fill(false) };
      }
      rounds.push(roundObj);
    }
    store.days[dayKey] = { createdAt: Date.now(), rounds };
    saveStore();
  }

  // -------------------- UI --------------------
  const $ = (s) => document.querySelector(s);
  const roundsWrap = $("#roundsWrap");
  const historyWrap = $("#historyWrap");
  const programGrid = $("#programGrid");

  // Timers keyed by unique rep key: `${dayKey}|${roundIndex}|${exId}|${repIndex}`
  const timers = new Map();

  function setTodayHeader() {
    const d = new Date();
    $("#todayLine").textContent = `Today: ${d.toLocaleDateString()}`;
  }

  function computeProgress(dayKey) {
    const day = store.days[dayKey];
    let done = 0, total = 0;

    for (let r = 0; r < PROGRAM.circuitsPerDay; r++) {
      for (const ex of PROGRAM.exercises) {
        const arr = day.rounds[r][ex.id].reps;
        total += arr.length;
        done += arr.filter(Boolean).length;
      }
    }
    return { done, total, pct: total ? Math.round((done/total)*100) : 0 };
  }

  function renderProgressLine() {
    const { done, total, pct } = computeProgress(todayKey);
    $("#progressLine").textContent = `Checked: ${done}/${total} (${pct}%)`;
  }

  function renderToday() {
    roundsWrap.innerHTML = "";
    const day = store.days[todayKey];

    for (let r = 0; r < PROGRAM.circuitsPerDay; r++) {
      const details = document.createElement("details");
      details.className = "round";
      details.open = (r === 0); // open first by default

      const roundDone = roundCompletion(todayKey, r);
      const roundBadge = roundDone === 100 ? "✅ Complete" : `${roundDone}%`;

      const summary = document.createElement("summary");
      summary.innerHTML = `
        <div class="row" style="gap:12px;">
          <div style="font-weight:700;">Round ${r+1}</div>
          <span class="badge">${roundBadge}</span>
        </div>
        <div class="muted small">Tap to ${details.open ? "collapse" : "expand"}</div>
      `;
      details.appendChild(summary);

      const inner = document.createElement("div");
      inner.style.padding = "12px";
      inner.style.display = "flex";
      inner.style.flexDirection = "column";
      inner.style.gap = "12px";

      for (const ex of PROGRAM.exercises) {
        const card = document.createElement("div");
        card.className = "card";

        const meta = ex.holdSec > 0
          ? `<span class="badge">${ex.reps} reps</span><span class="badge">${ex.holdSec}s ${escapeHtml(ex.holdLabel)}</span>`
          : `<span class="badge">${ex.reps} reps</span><span class="badge">no hold</span>`;

        card.innerHTML = `
          <div class="exTitle">${escapeHtml(ex.name)}</div>
          <div class="exMeta">${meta}</div>
          <div class="repGrid" data-round="${r}" data-ex="${ex.id}"></div>
        `;

        const repGrid = card.querySelector(".repGrid");
        const repsArr = day.rounds[r][ex.id].reps;

        for (let i = 0; i < ex.reps; i++) {
          const cell = document.createElement("div");
          cell.className = "repCell";

          const checked = repsArr[i] === true;

          const repKey = `${todayKey}|${r}|${ex.id}|${i}`;
          const holdHtml = ex.holdSec > 0 ? `
            <div class="holdWrap">
              <span class="holdTime" id="t_${cssSafe(repKey)}">${formatSS(ex.holdSec)}</span>
              <button class="holdBtn" id="b_${cssSafe(repKey)}" ${checked ? "disabled" : ""}>Start</button>
            </div>
          ` : "";

          cell.innerHTML = `
            <input type="checkbox" ${checked ? "checked" : ""} aria-label="Rep ${i+1}">
            <span class="repNum">#${i+1}</span>
            ${holdHtml}
          `;

          const cb = cell.querySelector('input[type="checkbox"]');
          cb.addEventListener("change", () => {
            stopTimer(repKey, true);
            repsArr[i] = cb.checked;
            saveStore();
            updateRoundHeader(details, r);
            renderProgressLine();
            // if checked, disable hold button
            if (ex.holdSec > 0) {
              const btn = cell.querySelector(".holdBtn");
              const lbl = cell.querySelector(".holdTime");
              if (btn) btn.disabled = cb.checked;
              if (lbl) lbl.textContent = formatSS(ex.holdSec);
            }
          });

          if (ex.holdSec > 0) {
            const btn = cell.querySelector(".holdBtn");
            btn.addEventListener("click", () => startCountdown(repKey, ex.holdSec, () => {
              cb.checked = true;
              cb.dispatchEvent(new Event("change"));
            }));
          }

          repGrid.appendChild(cell);
        }

        inner.appendChild(card);
      }

      details.appendChild(inner);
      roundsWrap.appendChild(details);

      details.addEventListener("toggle", () => updateRoundHeader(details, r));
    }

    renderProgressLine();
  }

  function roundCompletion(dayKey, roundIndex) {
    const day = store.days[dayKey];
    let done = 0, total = 0;
    for (const ex of PROGRAM.exercises) {
      const arr = day.rounds[roundIndex][ex.id].reps;
      total += arr.length;
      done += arr.filter(Boolean).length;
    }
    return total ? Math.round((done/total)*100) : 0;
  }

  function updateRoundHeader(detailsEl, roundIndex) {
    const pct = roundCompletion(todayKey, roundIndex);
    const badge = detailsEl.querySelector(".badge");
    if (badge) badge.textContent = (pct === 100 ? "✅ Complete" : `${pct}%`);
  }

  // -------------------- Timers --------------------
  function startCountdown(repKey, seconds, onDone) {
    // If already running, stop it
    if (timers.has(repKey)) stopTimer(repKey, false);

    const label = document.getElementById("t_" + cssSafe(repKey));
    const btn = document.getElementById("b_" + cssSafe(repKey));
    if (!label || !btn) return;

    let remaining = seconds;
    label.textContent = formatSS(remaining);
    btn.textContent = "Stop";

    const interval = setInterval(() => {
      remaining -= 1;
      label.textContent = formatSS(Math.max(0, remaining));
      if (remaining <= 0) {
        stopTimer(repKey, false);
        onDone?.();
      }
    }, 1000);

    btn.onclick = () => stopTimer(repKey, false);
    timers.set(repKey, { interval, seconds });
  }

  function stopTimer(repKey, resetLabel) {
    const t = timers.get(repKey);
    if (t?.interval) clearInterval(t.interval);
    timers.delete(repKey);

    const label = document.getElementById("t_" + cssSafe(repKey));
    const btn = document.getElementById("b_" + cssSafe(repKey));
    if (btn) {
      btn.textContent = "Start";
      // restore default click later via re-render; keep simple:
      btn.onclick = null;
    }
    if (resetLabel && label) {
      // try to infer exercise default from key
      const parts = repKey.split("|");
      const exId = parts[2];
      const ex = PROGRAM.exercises.find(e => e.id === exId);
      if (ex && ex.holdSec > 0) label.textContent = formatSS(ex.holdSec);
    }
  }

  function formatSS(sec) {
    return String(sec).padStart(2, "0") + "s";
  }

  function cssSafe(str) {
    // simple transform to valid id fragments
    return str.replaceAll("|","_").replaceAll(":","_").replaceAll(" ","_");
  }

  // -------------------- History --------------------
  function renderHistory() {
    const keys = Object.keys(store.days).sort().reverse();
    if (!keys.length) {
      historyWrap.innerHTML = `<div class="card muted">No data yet.</div>`;
      return;
    }

    const rows = keys.map(k => {
      const { done, total, pct } = computeProgress(k);
      const complete = pct === 100 ? "✅" : "";
      return { date: k, done, total, pct, complete };
    });

    historyWrap.innerHTML = `
      <div class="card">
        <table>
          <thead>
            <tr><th>Date</th><th>Progress</th><th>Percent</th></tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><b>${escapeHtml(r.date)}</b> <span class="muted">${r.complete}</span></td>
                <td>${r.done}/${r.total}</td>
                <td>${r.pct}%</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
  }

  // -------------------- Settings (read-only for now) --------------------
  function renderSettings() {
    programGrid.innerHTML = "";
    for (const ex of PROGRAM.exercises) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div style="font-weight:700;">${escapeHtml(ex.name)}</div>
        <div class="muted" style="margin-top:6px;">
          ${ex.reps} reps
          ${ex.holdSec > 0 ? ` • ${ex.holdSec}s ${escapeHtml(ex.holdLabel)}` : " • no hold"}
        </div>
      `;
      programGrid.appendChild(card);
    }
  }

  // -------------------- Tabs + Actions --------------------
  function renderTabs() {
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const target = btn.dataset.tab;
        document.querySelectorAll(".tabpane").forEach(p => p.hidden = true);
        $("#" + target).hidden = false;

        if (target === "today") {
          // no-op
        } else if (target === "history") {
          renderHistory();
        } else if (target === "settings") {
          renderSettings();
        }
      });
    });
  }

  $("#expandAllBtn").addEventListener("click", () => {
    document.querySelectorAll("details.round").forEach(d => d.open = true);
  });
  $("#collapseAllBtn").addEventListener("click", () => {
    document.querySelectorAll("details.round").forEach(d => d.open = false);
  });

  $("#resetTodayBtn").addEventListener("click", () => {
    if (!confirm("Reset all checkboxes for today?")) return;
    // stop all timers
    for (const k of Array.from(timers.keys())) stopTimer(k, false);
    delete store.days[todayKey];
    ensureDay(todayKey);
    renderToday();
  });

  $("#deleteAllBtn").addEventListener("click", () => {
    if (!confirm("Delete ALL data (all days)?")) return;
    for (const k of Array.from(timers.keys())) stopTimer(k, false);
    localStorage.removeItem(LS_KEY);
    location.reload();
  });

  // -------------------- Utils --------------------
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // -------------------- Service worker --------------------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try { await navigator.serviceWorker.register("./sw.js"); } catch {}
    });
  }

  // -------------------- Init --------------------
  setTodayHeader();
  renderTabs();
  renderToday();
</script>
</body>
</html>
