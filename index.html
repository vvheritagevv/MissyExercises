<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Exercise Program</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b1220; color:#e5e7eb; }
    header { padding:16px; position:sticky; top:0; background:#0b1220cc; backdrop-filter: blur(8px); border-bottom:1px solid #243045; z-index:10; }
    h1 { margin:0; font-size:18px; }
    .muted { color:#9ca3af; font-size:12px; }
    .small { font-size:12px; }
    main { padding:16px; max-width:1100px; margin:0 auto; }

    .tabs { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    button, input, select { font:inherit; }

    .tab, .btn {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #243045;
      background:#111b2f;
      color:#e5e7eb;
      cursor:pointer;
    }
    .tab.active { background:#1f2a44; border-color:#3b4b6a; }
    .btn.primary { background:#2563eb; border-color:#2563eb; }
    .btn.danger { background:#b91c1c; border-color:#b91c1c; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spaced { justify-content:space-between; }

    .card {
      background:#0f1a2e;
      border:1px solid #243045;
      border-radius:14px;
      padding:12px;
    }

    details.round {
      background:#0f1a2e;
      border:1px solid #243045;
      border-radius:14px;
      overflow:hidden;
    }

    summary {
      list-style:none;
      cursor:pointer;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    summary::-webkit-details-marker { display:none; }

    .badge {
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #243045;
      background:#111b2f;
      font-size:12px;
      color:#cbd5e1;
    }

    .exTitle { font-weight:600; }
    .exMeta { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }

    /* ---------- Rep grid ---------- */
    .repGrid {
      display:grid;
      grid-template-columns:repeat(5, minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }

    .repCell {
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px;
      border:1px solid #243045;
      border-radius:12px;
      background:#0b1220;
      flex-wrap:wrap;
    }

    .repCell input { width:18px; height:18px; }
    .repNum { font-size:12px; color:#cbd5e1; }

    .holdWrap {
      display:flex;
      gap:8px;
      width:100%;
      justify-content:flex-end;
      align-items:center;
    }

    .holdTime { font-size:12px; color:#cbd5e1; }
    .holdBtn {
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #243045;
      background:#111b2f;
      color:#e5e7eb;
      cursor:pointer;
      font-size:12px;
    }

    @media (max-width:420px) {
      .repGrid { grid-template-columns:repeat(3, minmax(0,1fr)); }
    }
    @media (min-width:421px) and (max-width:720px) {
      .repGrid { grid-template-columns:repeat(4, minmax(0,1fr)); }
    }

    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #243045; padding:8px; font-size:13px; text-align:left; }
  </style>
</head>

<body>
<header>
  <h1>Home Exercise Program</h1>
  <div class="muted" id="todayLine"></div>

  <div class="tabs">
    <button class="tab active" data-tab="today">Today</button>
    <button class="tab" data-tab="history">History</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>
</header>

<main>
  <!-- TODAY -->
  <section id="today" class="tabpane">
    <div class="row spaced">
      <div>
        <div class="muted">4 rounds per day — progress auto-saves</div>
        <div class="muted small" id="progressLine"></div>
      </div>
      <div class="row">
        <button class="btn" id="exportPdfBtn">Export PDF</button>
        <button class="btn" id="expandAllBtn">Expand all</button>
        <button class="btn" id="collapseAllBtn">Collapse all</button>
        <button class="btn danger" id="resetTodayBtn">Reset today</button>
      </div>
    </div>

    <div id="roundsWrap" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;"></div>

    <div class="muted small" style="margin-top:12px;">
      Hold timers play a beep at start and completion. Reps auto-check when holds finish.
    </div>
  </section>

  <!-- HISTORY -->
  <section id="history" class="tabpane" hidden>
    <div class="row spaced">
      <div class="muted">Daily summary</div>
      <button class="btn danger" id="deleteAllBtn">Delete all data</button>
    </div>
    <div id="historyWrap" style="margin-top:12px;"></div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="tabpane" hidden>
    <div class="card">
      <div class="muted">Program details</div>
      <div id="programGrid" style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px;"></div>
    </div>
  </section>
</main>

<script>
/* ============================================================
   DATA + PROGRAM
============================================================ */
const LS_KEY = "hep_pwa_v3";

const PROGRAM = {
  circuitsPerDay: 4,
  exercises: [
    { id:"heel", name:"Supine Heel Slide", reps:10, hold:5, desc:"Slide heel toward buttocks, bend knee, hold briefly, then straighten." },
    { id:"gluteSet", name:"Gluteal Set", reps:10, hold:10, desc:"Tighten glute muscles without moving legs." },
    { id:"quadSet", name:"Quad Set", reps:10, hold:10, desc:"Tighten thigh by pressing knee downward." },
    { id:"slr", name:"Straight Leg Raise (Flexion)", reps:10, hold:0, desc:"Lift straight leg to opposite knee height, lower slowly." },
    { id:"bridge", name:"Glute Bridge", reps:10, hold:10, desc:"Lift hips by squeezing glutes, hold, then lower." },
    { id:"laq", name:"Eccentric Long Arc Quad", reps:10, hold:0, desc:"Straighten knee fully, then slowly lower." },
    { id:"ankle", name:"Ankle Pumps", reps:10, hold:0, desc:"Pump ankle up and down through full range." }
  ]
};

let store = JSON.parse(localStorage.getItem(LS_KEY) || '{"days":{}}');

/* ============================================================
   AUDIO CUES
============================================================ */
let audioCtx;
function beep(freq=800, ms=120) {
  audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = freq;
  g.gain.value = 0.05;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=>o.stop(), ms);
}

/* ============================================================
   UTIL
============================================================ */
const $ = s => document.querySelector(s);
const todayKey = new Date().toISOString().slice(0,10);

function ensureDay() {
  if (store.days[todayKey]) return;
  store.days[todayKey] = {
    rounds: Array.from({length:4},()=>Object.fromEntries(PROGRAM.exercises.map(e=>[e.id,Array(e.reps).fill(false)]))),
    pain: Array(4).fill(null),
    created: Date.now()
  };
  save();
}

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(store)); }

/* ============================================================
   RENDERING
============================================================ */
function renderToday(){
  ensureDay();
  const wrap=$("#roundsWrap"); wrap.innerHTML="";
  const day=store.days[todayKey];

  day.rounds.forEach((round,r)=>{
    const done=roundCompletion(r);
    const pain=day.pain[r];
    const details=document.createElement("details");
    details.className="round";
    details.open=r===0;
    details.innerHTML=`
      <summary>
        <div class="row"><b>Round ${r+1}</b><span class="badge">${done}%${pain!=null?` • Pain ${pain}/10`:""}</span></div>
        <span class="muted small">tap</span>
      </summary>
      <div style="padding:12px; display:flex; flex-direction:column; gap:12px;"></div>
    `;
    const inner=details.querySelector("div");

    /* pain selector */
    const painCard=document.createElement("div");
    painCard.className="card";
    painCard.innerHTML=`
      <div class="row spaced">
        <div><b>Pain score (0–10)</b></div>
        <select>${["","0","1","2","3","4","5","6","7","8","9","10"].map(v=>`<option ${v==pain?"selected":""}>${v}</option>`).join("")}</select>
      </div>`;
    painCard.querySelector("select").onchange=e=>{
      day.pain[r]=e.target.value===""?null:+e.target.value;
      save(); renderToday();
    };
    inner.appendChild(painCard);

    PROGRAM.exercises.forEach(ex=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <div class="exTitle">${ex.name}</div>
        <div class="muted small">${ex.desc}</div>
        <div class="exMeta"><span class="badge">${ex.reps} reps</span>${ex.hold?`<span class="badge">${ex.hold}s hold</span>`:""}</div>
        <div class="repGrid"></div>`;
      const grid=card.querySelector(".repGrid");

      round[ex.id].forEach((v,i)=>{
        const cell=document.createElement("div");
        cell.className="repCell";
        cell.innerHTML=`<input type="checkbox" ${v?"checked":""}><span class="repNum">#${i+1}</span>`;
        const cb=cell.querySelector("input");
        cb.onchange=()=>{ round[ex.id][i]=cb.checked; save(); renderToday(); };
        if(ex.hold){
          const hw=document.createElement("div");
          hw.className="holdWrap";
          const btn=document.createElement("button");
          btn.className="holdBtn";
          btn.textContent="Start";
          btn.onclick=()=>{
            let t=ex.hold;
            btn.textContent=`${t}s`;
            beep(500,80);
            const iv=setInterval(()=>{
              t--; btn.textContent=`${t}s`;
              if(t<=0){ clearInterval(iv); beep(900,120); cb.checked=true; cb.onchange(); }
            },1000);
          };
          hw.appendChild(btn);
          cell.appendChild(hw);
        }
        grid.appendChild(cell);
      });

      inner.appendChild(card);
    });

    wrap.appendChild(details);
  });

  $("#progressLine").textContent=`Checked ${computeDone()}`;
}

function roundCompletion(r){
  const day=store.days[todayKey];
  let d=0,t=0;
  PROGRAM.exercises.forEach(ex=>{
    const a=day.rounds[r][ex.id];
    t+=a.length; d+=a.filter(Boolean).length;
  });
  return Math.round(d/t*100);
}

function computeDone(){
  const day=store.days[todayKey];
  let d=0,t=0;
  day.rounds.forEach((_,r)=>{
    PROGRAM.exercises.forEach(ex=>{
      const a=day.rounds[r][ex.id];
      t+=a.length; d+=a.filter(Boolean).length;
    });
  });
  return `${d}/${t}`;
}

/* ============================================================
   HISTORY + PDF EXPORT
============================================================ */
function exportPdf(){
  const w=window.open("","_blank");
  w.document.write(`<pre>${JSON.stringify(store.days[todayKey],null,2)}</pre>`);
  w.print();
}

/* ============================================================
   INIT + EVENTS
============================================================ */
$("#todayLine").textContent=`Today: ${todayKey}`;
$("#exportPdfBtn").onclick=exportPdf;
$("#resetTodayBtn").onclick=()=>{ if(confirm("Reset today?")){ delete store.days[todayKey]; save(); renderToday(); }};
$("#deleteAllBtn").onclick=()=>{ if(confirm("Delete all data?")){ localStorage.removeItem(LS_KEY); location.reload(); }};
$("#expandAllBtn").onclick=()=>document.querySelectorAll("details").forEach(d=>d.open=true);
$("#collapseAllBtn").onclick=()=>document.querySelectorAll("details").forEach(d=>d.open=false);

document.querySelectorAll(".tab").forEach(b=>b.onclick=()=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  document.querySelectorAll(".tabpane").forEach(p=>p.hidden=true);
  $("#"+b.dataset.tab).hidden=false;
});

renderToday();
</script>
</body>
</html>
